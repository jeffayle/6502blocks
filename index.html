<!doctype html>
<script type="module">
  // [x, y, invert, [nodes]]
  const register_list_data = [
    // data bus
    [731, 206, false, [1005,82,945,650,1393,175,1591,1349]],
    // instruction register
    [166, 788, true, [194,702,1182,1125,26,1394,895,1320]],
    // address bus low
    [1837, 1560, false, [268,451,1340,211,435,736,887,1493]],
    // address bus high
    [1837, 826, false, [230,148,1443,399,1237,349,672,195]],
    // predecode register
    [537, 215, true, [758,361,955,894,369,829,1669,1690]]
  ];
  const signal_list = [
    ["clk1", 1163, false],
    ["clk2", 421, false],
    ["t0", 1536, true],
    ["t1", 156, true],
    ["t2", 971, true],
    ["t3", 1567, true],
    ["t4", 690, true],
    ["t5", 909, true]
  ];

  var proc;
  var svg_doc
  var simulator;

  function $(x) {
    return document.getElementById(x);
  }

  function single_step() {
    simulator.step(proc);
    function set_colour(cls, col) {
      let matches = svg_doc.getElementsByClassName(cls);
      for (let i=0; i<matches.length; i++) {
        matches[i].style.color = col;
        matches[i].style.solidColor = col;
        matches[i].style.fill = col;
        matches[i].stroke = col;
      }
    }
    for (let i=0; i<signal_list.length; i++) {
      let value = simulator.readNode(proc, signal_list[i][1]);
      if (signal_list[i][2])
        value = ! value;
      set_colour(signal_list[i][0], value?'red':'grey');
    }
  }

  /* load wasm */
  async function init() {
    const { instance } = await WebAssembly.instantiateStreaming(
      fetch("./6502.wasm")
    );
    simulator = instance.exports;
    proc = simulator.initAndResetChip();
    console.log(proc);
    $("step_button").addEventListener(
        "click", single_step);
  }
  init();

  window.addEventListener("load", function() {
    svg_doc = $("diagram").contentDocument;
  });
  
</script>

<style type="text/css">
  input[type=button] {
    position: fixed;
    top: 0; left: 0;
  }
</style>

<section id=view>
  <input type=button value=step id=step_button>
  <object id="diagram" data="6502block.svg" type="image/svg+xml">
  </object>
</section>
