<!doctype html>
<script type="module">
  const BIT = 0;
  const BIT_INV = 1;
  const BYTE_ = 2;
  const BYTE_INV = 3;

  const simulator = new Worker("./6502.js");
  var svg_doc;
  var signal_list = [];
  var history = [];
  var history_forward = [];

  function $(x) {
    return document.getElementById(x);
  }

  simulator.onmessage = function(event) {
    let [message,param] = event.data;
    if (message == "init") {
      signal_list = param;
    } else if (message == "step") {
      if (history_forward.length == 0) {
        update_diagram(param);
        history.push(param);
        if (history.length > 10)
          history.shift();
        $("back_button").disabled = false;
      } else {
        history_forward.unshift(param);
      }
    }
  }

  function single_step() {
    if (history_forward.length > 0) {
      let state = history_forward.pop();
      history.push(state);
      update_diagram(state);
    } else {
      simulator.postMessage(["step", null]);
    }
  }

  function step_back() {
    if (history.length == 0)
      return;
    history_forward.push(history.pop());
    if (history.length == 0)
      $("back_button").disabled = true;
    update_diagram(history[history.length-1]);
  }

  function update_diagram(state) {
    function set_bit(cls, value) {
      let matches = svg_doc.getElementsByClassName(cls);
      for (let i=0; i<matches.length; i++) {
        if (matches[i].classList.contains("overlay")) {
          matches[i].style.display = value ? "inline":"none";
        } else {
          let col = value ? 'red':'grey';
          matches[i].style.color = col;
          matches[i].style.solidColor = col;
          matches[i].style.fill = col;
          matches[i].stroke = col;
        }
      }
    }
    function set_register(cls, value) {
      let matches = $("diagram").getElementsByClassName(cls);
      value = value.toString(16);
      if (value.length < 2)
        value = "0" + value;
      for (let i=0; i<matches.length; i++)
        matches[i].value = value;
    }
    for (let i=0; i<signal_list.length; i++) {
      let [name,type] = signal_list[i];
      if (type==BIT || type==BIT_INV)
        set_bit(name, state[i]);
      else if (type==BYTE_ || type==BYTE_INV)
        set_register(name, state[i]);
    }
  }

  window.addEventListener("load", function() {
    svg_doc = $("diagram").getElementsByTagName("object")[0].contentDocument;
    $("step_button").addEventListener("click", single_step);
    $("back_button").addEventListener("click", step_back);
    $("run_button").addEventListener("click", function(){
      simulator.postMessage(["run", null]);
    });
  });
  
</script>

<style type="text/css">
  #controls {
    position: sticky;
    top: 8px; left: 0;
    z-index: 10;
  }
  #diagram > div { position: relative; }
  #diagram input[type=text] {
    position: absolute;
    font-size: 16px;
    width: 32px;
    font-family: monospace;
    background-color: #ff9;
    text-align: center;
  }
  #diagram input[type=text].small {
    font-size: 12px;
    width: 24px;
  }
  #diagram input[type=text].tiny {
    font-size: 8px;
    width: 16px;
  }

  input[name=tab]:checked + label {
    background-color: red;
  }

  .tab_content { display: none; }
  input[name=tab] { display: none; }
  #tab_processor:checked ~ #diagram { display: block; }
  #tab_io:checked ~ #io { display: block; }
</style>

<div id=controls>
  <input type=button value=step id=step_button><!--
  --><input type=button value=back id=back_button disabled><!--
  --><input type=button value=run id=run_button>
</div>

<input type=radio name=tab id=tab_processor checked>
<label for=tab_processor> Processor </label>
<input type=radio name=tab id=tab_io>
<label for=tab_io> I/O </label>

<section id=diagram class=tab_content>
  <div>
  <object data="6502block.svg" type="image/svg+xml"></object>
  <input type=text readonly class=ir style="left: 55px; top: 374px;">
  <input type=text readonly class=DB style="left: 247px; top: 70px;">
  <input type=text readonly class="pd tiny" style="left: 181px; top: 164px;">
  <input type=text readonly class="dor small" style="left: 250px; top: 279px;">
  <input type=text readonly class=pd style="left: 332px; top: 150px;">
  <input type=text readonly class="pcls small" style="left: 403px; top: 224px;">
  <input type=text readonly class=pcl style="left: 403px; top: 339px;">
  <input type=text readonly class=pchs style="left: 547px; top: 222px;">
  <input type=text readonly class=pch style="left: 550px; top: 377px;">
  <input type=text readonly class=abh style="left: 679px; top: 367px;">
  <input type=text readonly class=abl style="left: 677px; top: 636px;">
  <input type=text readonly class=s style="left: 540px; top: 533px;">
  <input type=text readonly class="ai small" style="left: 425px; top: 800px;">
  <input type=text readonly class="bi small" style="left: 425px; top: 589px;">
  <input type=text readonly class="add small" style="left: 541px; top: 715px;">
  <input type=text readonly class=x style="left: 680px; top: 781px;">
  <input type=text readonly class=y style="left: 680px; top: 940px;">
  </div>
  <input type=text readonly class=ac style="left: 459px; top: 981px;">
</section>

<section id=io class=tab_content>
  <pre></pre>
  <input type=text placeholder="keyboard input">
</section>
