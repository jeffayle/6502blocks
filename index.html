<!doctype html>
<script type="module">
  const BIT = 0;
  const BIT_INV = 1;
  const BYTE_ = 2;
  const BYTE_INV = 3;

  const simulator = new Worker("./6502.js");
  var svg_doc = null;
  var signal_list = [];
  var history = [];
  var history_forward = [];

  window.addEventListener("DOMContentLoaded", function() {
    $("diagram_svg").addEventListener("load", function(){
      svg_doc = this.contentDocument;
    });
    $("step_button").addEventListener("click", single_step);
    $("back_button").addEventListener("click", step_back);
    $("run_button").addEventListener("click", function(){
      simulator.postMessage(["run", []]);
    });
    $("reset_button").addEventListener("click", function(){
      simulator.postMessage(["reset", []]);
    });
    load_ram("testsuite.bin");
    simulator.onmessage = simulator_onmessage;
  });

  function simulator_onmessage(event) {
    let [message,param] = event.data;
    if (message == "init") {
      signal_list = param;
      attach_breakpoint_interface_events();
    } else if (message == "step") {
      if (history_forward.length == 0) {
        update_diagram(param);
        history.push(param);
        if (history.length > 10)
          history.shift();
        $("back_button").disabled = false;
      } else {
        history_forward.unshift(param);
      }
    }
  }

  function $(x) {
    return document.getElementById(x);
  }

  function single_step() {
    if (history_forward.length > 0) {
      let state = history_forward.pop();
      history.push(state);
      update_diagram(state);
    } else {
      simulator.postMessage(["step", null]);
    }
  }

  function step_back() {
    if (history.length == 0)
      return;
    history_forward.push(history.pop());
    if (history.length == 0)
      $("back_button").disabled = true;
    update_diagram(history[history.length-1]);
  }

  function update_diagram(state) {
    function set_bit(cls, value) {
      let matches = svg_doc.getElementsByClassName(cls);
      for (let i=0; i<matches.length; i++) {
        if (matches[i].classList.contains("overlay")) {
          matches[i].style.display = value ? "inline":"none";
        } else {
          let col = value ? 'red':'grey';
          matches[i].style.color = col;
          matches[i].style.solidColor = col;
          matches[i].style.fill = col;
          matches[i].stroke = col;
        }
      }
    }
    function set_register(cls, value) {
      let matches = $("diagram").getElementsByClassName(cls);
      value = value.toString(16);
      if (value.length < 2)
        value = "0" + value;
      for (let i=0; i<matches.length; i++)
        matches[i].value = value;
    }
    for (let i=0; i<signal_list.length; i++) {
      let [name,type] = signal_list[i];
      if (type==BIT || type==BIT_INV)
        set_bit(name, state[i]);
      else if (type==BYTE_ || type==BYTE_INV)
        set_register(name, state[i]);
    }
  }

  async function load_ram(fname) {
    const memory_response = await fetch(fname);
    const new_memory = new Uint8Array(await memory_response.arrayBuffer());
    simulator.postMessage(["init", new_memory]);
    simulator.postMessage(["reset", []]);
    /* RAM table */
    let table = $("ram").getElementsByTagName("table")[0];
    let table_body = document.createElement("tbody");
    table.appendChild(table_body);
    let table_row = null;
    for (let i=0; i<65536; i++) {
      if (i % 16 == 0) {
        if (table_row)
          table_body.appendChild(table_row);
        table_row = document.createElement("tr");
        let header = document.createElement("th");
        header.innerHTML = (i/16).toString(16) + "x";
        table_row.appendChild(header);
      }
      if (i % 256 == 0) {
        table.appendChild(table_body);
        table_body = document.createElement("tbody");
        table.appendChild(table_body);
      }
      let cell = document.createElement("td");
      let container = document.createElement("div");
      cell.appendChild(container);
      let value = new_memory[i].toString(16);
      if (new_memory[i] < 0x10)
        value = "0" + value;
      container.innerHTML = value;
      table_row.appendChild(cell);
      /* when cell is double clicked, turn div into input */
      cell.addEventListener("dblclick", function(event) {
        let old_value = this.firstChild.innerHTML;
        this.removeChild(this.firstChild);
        let input = document.createElement("input");
        input.type = "text";
        input.value = old_value;
        this.appendChild(input);
        input.focus();
        /* turn back into a div */
        input.addEventListener("focusout", function() {
          let new_value = parseInt(this.value,16);
          if (isNaN(new_value) || new_value<0 || new_value>255)
            new_value = old_value;
          if (value < 0x10)
            new_value = "0" + new_value.toString(16);
          else
            new_value = new_value.toString(16);
          let cell = this.parentNode;
          let new_div = document.createElement("div");
          new_div.innerHTML = new_value;
          cell.removeChild(this);
          cell.appendChild(new_div);
        });
      });
    }
  }

  function signal_id(name) {
    for (let i=0; i<signal_list.length; i++)
      if (signal_list[i][0] == name)
        return i;
    return null;
  }

  function attach_breakpoint_interface_events() {
    /* if the svg document is not yet loaded then schedule ourself
    when it has */
    if (svg_doc === null) {
      $("diagram_svg").addEventListener("load",
          attach_breakpoint_interface_events);
      return;
    }
    for (let sid=0; sid<signal_list.length; sid++) {
      let signal_id = sid;
      let [signal_name, signal_type] = signal_list[signal_id];
      let elements = svg_doc.getElementsByClassName(signal_name);
      for (let elem_id=0; elem_id<elements.length; elem_id++) {
        let elem = elements[elem_id];
        elem.style.cursor = "pointer";
        elem.style.userSelect = "none";
        elem.addEventListener("dblclick", function(){
          if (history[history.length-1][signal_id])
            simulator.postMessage(["run", [-signal_id]]);
          else
            simulator.postMessage(["run", [signal_id]]);
        });
      }
    }
  }
</script>

<style type="text/css">
  #controls {
    position: sticky;
    top: 8px; left: 0;
    z-index: 10;
  }
  #diagram > div { position: relative; }
  #diagram input[type=text] {
    position: absolute;
    font-size: 16px;
    width: 32px;
    font-family: monospace;
    background-color: #ff9;
    text-align: center;
  }
  #diagram input[type=text].small {
    font-size: 12px;
    width: 24px;
  }
  #diagram input[type=text].tiny {
    font-size: 8px;
    width: 16px;
  }

  input[name=tab]:checked + label {
    background-color: red;
  }

  .tab_content { display: none; }
  input[name=tab] { display: none; }
  #tab_processor:checked ~ #diagram { display: block; }
  #tab_io:checked ~ #io { display: block; }
  #tab_ram:checked ~ #ram { display: block; }
  #tab_debug:checked ~ #debug { display: block; }

  tbody:nth-child(even) {
    background-color: #ccc;
  }

  #ram table {
    font-family: monospace;
  }
  #ram table div {
    width: 3em;
  }
  #ram table input {
    width: 3em;
  }
</style>

<div id=controls>
  <input type=button value=step id=step_button><!--
  --><input type=button value=back id=back_button disabled><!--
  --><input type=button value=run id=run_button><!--
  --><input type=button value=reset id=reset_button>
</div>

<input type=radio name=tab id=tab_processor checked>
<label for=tab_processor> Processor </label>
<input type=radio name=tab id=tab_io>
<label for=tab_io> I/O </label>
<input type=radio name=tab id=tab_ram>
<label for=tab_ram>RAM</label>

<section id=diagram class=tab_content>
  <div>
  <object data="6502block.svg" type="image/svg+xml" id=diagram_svg></object>
  <input type=text readonly class=ir style="left: 55px; top: 374px;">
  <input type=text readonly class=DB style="left: 247px; top: 70px;">
  <input type=text readonly class="pd tiny" style="left: 181px; top: 164px;">
  <input type=text readonly class="dor small" style="left: 250px; top: 279px;">
  <input type=text readonly class=pd style="left: 332px; top: 150px;">
  <input type=text readonly class="pcls small" style="left: 403px; top: 224px;">
  <input type=text readonly class=pcl style="left: 403px; top: 339px;">
  <input type=text readonly class=pchs style="left: 547px; top: 222px;">
  <input type=text readonly class=pch style="left: 550px; top: 377px;">
  <input type=text readonly class=abh style="left: 679px; top: 367px;">
  <input type=text readonly class=abl style="left: 677px; top: 636px;">
  <input type=text readonly class=s style="left: 540px; top: 533px;">
  <input type=text readonly class="ai small" style="left: 425px; top: 800px;">
  <input type=text readonly class="bi small" style="left: 425px; top: 589px;">
  <input type=text readonly class="add small" style="left: 541px; top: 715px;">
  <input type=text readonly class=x style="left: 680px; top: 781px;">
  <input type=text readonly class=y style="left: 680px; top: 940px;">
  <input type=text readonly class=ac style="left: 459px; top: 981px;">
  </div>
</section>

<section id=io class=tab_content>
  <pre></pre>
  <input type=text placeholder="keyboard input">
</section>

<section id=ram class=tab_content>
  <table>
    <thead>
      <tr>
        <th></th>
        <td>0</td> <td>1</td> <td>2</td> <td>3</td>
        <td>4</td> <td>5</td> <td>6</td> <td>7</td>
        <td>8</td> <td>9</td> <td>a</td> <td>b</td>
        <td>c</td> <td>d</td> <td>e</td> <td>f</td>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</section>
