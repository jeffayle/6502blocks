<!doctype html>
<script type="module">
  // [x, y, invert, [nodes]]
  const register_list_data = [
    // data bus
    [731, 206, false, [1005,82,945,650,1393,175,1591,1349]],
    // instruction register
    [166, 788, true, [194,702,1182,1125,26,1394,895,1320]],
    // address bus low
    [1837, 1560, false, [268,451,1340,211,435,736,887,1493]],
    // address bus high
    [1837, 826, false, [230,148,1443,399,1237,349,672,195]],
    // predecode register
    [537, 215, true, [758,361,955,894,369,829,1669,1690]]
  ];
  const overlay_list_data = [
    ["clk1", 1163],
    ["clk2", 421]
  ];

  var proc;
  var simulator;
  var register_list = [];
  var overlay_list = [];

  function $(x) {
    return document.getElementById(x);
  }

  function single_step() {
    simulator.step(proc);
    for (let i=0; i<register_list_data.length; i++) {
      let value = simulator.readNode8.apply(null,
          [proc].concat(register_list_data[i][3]))
      if (register_list_data[i][2])
        value ^= 255;
      register_list[i].value = value.toString(16);
    }
    for (let i=0; i<overlay_list_data.length; i++) {
      console.log(overlay_list_data[i][1]);
      let value = simulator.readNode(proc, overlay_list_data[i][1]);
      console.log(value);
      overlay_list[i].style.display = value ? 'block' : 'none';
    }
  }

  async function init() {
    const { instance } = await WebAssembly.instantiateStreaming(
      fetch("./6502.wasm")
    );
    simulator = instance.exports;
    proc = simulator.initAndResetChip();
    // create dom elements for output
    // <input>s for registers
    var parent_elem = $("view");
    for (let i=0; i<register_list_data.length; i++) {
      let new_elem = document.createElement("input");
      new_elem.type = "text";
      new_elem.value = "";
      new_elem.readOnly = true;
      new_elem.style.left = register_list_data[i][0] + "px";
      new_elem.style.top = register_list_data[i][1] + "px";
      parent_elem.appendChild(new_elem);
      register_list.push(new_elem);
    }
    // <img>s for overlays
    parent_elem = $("overlays");
    for (let i=0; i<overlay_list_data.length; i++) {
      let new_elem = document.createElement("img");
      new_elem.src = "overlay/"+overlay_list_data[i][0] + ".png";
      new_elem.style.display = 'none';
      parent_elem.appendChild(new_elem);
      overlay_list.push(new_elem);
    }
    console.log(proc);
    $("step_button").addEventListener(
        "click", single_step);
  }
  init();
  
</script>

<style type="text/css">
  #view {
    position: relative;
  }
  #view > input {
    position: absolute;
    font-size: 45px;
    width: 90px;
    text-align: center;
    background-color: #ff9;
  }
  #view > input[type=text]:hover {
    opacity: 0.1;
  }
  #view > input[type=button] {
    z-index: 10;
  }
  #overlays > img {
    position: absolute;
    top: 0;
    left: 0;
  }
</style>

<section id=view>
  <input type=button value=step id=step_button>
  <img src="hanson.jpg">
  <section id=overlays>
  </section>
</section>
